name: Validate Agent Action

on:
  pull_request:
    branches: [main]
    paths:
      - 'state/**'
      - 'worlds/**'
      - 'feed/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Checkout main for comparison
        run: git fetch origin main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate changes
        id: validate
        run: python scripts/validate_action.py
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}

      - name: Post validation result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const result = '${{ steps.validate.outcome }}';
            const errors = process.env.VALIDATION_ERRORS || '';
            
            if (result === 'success') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '✅ **Action validated.** Auto-merging.\n\n' + (process.env.VALIDATION_SUMMARY || '')
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '❌ **Action rejected.**\n\n' + errors
              });
            }
        env:
          VALIDATION_ERRORS: ${{ steps.validate.outputs.errors }}
          VALIDATION_SUMMARY: ${{ steps.validate.outputs.summary }}

      - name: Auto-merge valid PR
        if: steps.validate.outcome == 'success'
        run: gh pr merge ${{ github.event.pull_request.number }} --squash --auto
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
