name: State Consistency Audit

on:
  schedule:
    - cron: '0 */12 * * *'  # Every 12 hours
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # Enough history for PR drift detection

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run state consistency audit
        id: audit
        run: python scripts/validate_action.py --audit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const errors = process.env.AUDIT_ERRORS || 'See workflow logs for details.';
            const summary = process.env.AUDIT_SUMMARY || '';

            // Check for existing open audit issue to avoid duplicates
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'state-audit',
              state: 'open',
              per_page: 1,
            });

            const body = [
              '## üîç State Consistency Audit Failed',
              '',
              '**Errors found:**',
              errors,
              '',
              '**Summary:**',
              summary,
              '',
              `**Run:** [Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              '',
              '_This issue was automatically created by the state audit workflow._',
            ].join('\n');

            if (existing.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.data[0].number,
                body: body,
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '‚ö†Ô∏è State consistency audit detected issues',
                body: body,
                labels: ['state-audit', 'bug'],
              });
            }
        env:
          AUDIT_ERRORS: ${{ steps.audit.outputs.errors }}
          AUDIT_SUMMARY: ${{ steps.audit.outputs.summary }}
